# 实体抽取板块接口设计

本接口文档基于 `实体抽取板块数据库设计.md` 制定，遵循 RESTful 风格。

> **Base URL**: `/api/v1`

---

## 1. 项目管理 (Project)

### 1.1 创建项目
*   **URL**: `POST /projects/`
*   **Summary**: 创建一个新的资产抽取项目。
*   **Request Body**:
    ```json
    {
      "name": "我的剧本分析项目",
      "description": "测试项目"
    }
    ```
*   **Response (200 OK)**:
    ```json
    {
      "uid": "proj_01...",
      "name": "我的剧本分析项目",
      "description": "测试项目",
      "created_at": "2023-10-27T10:00:00Z",
      "updated_at": "2023-10-27T10:00:00Z"
    }
    ```

### 1.2 获取项目列表
*   **URL**: `GET /projects/`
*   **Summary**: 获取所有项目。
*   **Response (200 OK)**:
    ```json
    [
      {
        "uid": "proj_01...",
        "name": "我的剧本分析项目",
        "description": "测试项目",
        "created_at": "..."
      }
    ]
    ```

### 1.3 获取项目详情
*   **URL**: `GET /projects/{uid}`
*   **Summary**: 获取指定项目的详细信息。
*   **Response (200 OK)**:
    ```json
    {
      "uid": "proj_01...",
      "name": "我的剧本分析项目",
      "description": "测试项目",
      "created_at": "..."
    }
    ```

---

## 2. 剧本管理 (Script)

### 2.1 上传剧本
*   **URL**: `POST /projects/{project_uid}/scripts/`
*   **Summary**: 上传原始剧本内容。
*   **Request Body**:
    ```json
    {
      "name": "第一集",
      "content": "..."  // 原始剧本长文本
    }
    ```
*   **Response (200 OK)**:
    ```json
    {
      "uid": "script_01...",
      "project_uid": "proj_01...",
      "name": "第一集",
      "created_at": "..."
    }
    ```

### 2.2 获取剧本列表
*   **URL**: `GET /projects/{project_uid}/scripts/`
*   **Summary**: 获取项目下的所有剧本。
*   **Response (200 OK)**:
    ```json
    [
      {
        "uid": "script_01...",
        "name": "第一集",
        "created_at": "..."
      }
    ]
    ```

### 2.3 获取剧本详情 (包含原始内容)
*   **URL**: `GET /scripts/{uid}`
*   **Summary**: 获取剧本的原始内容。
*   **Response (200 OK)**:
    ```json
    {
      "uid": "script_01...",
      "name": "第一集",
      "content": "..."
    }
    ```

### 2.4 获取标准化剧本 (Step 1 产物)
*   **URL**: `GET /scripts/{uid}/normalized`
*   **Summary**: 获取经过 Step 1 标准化处理后的剧本（带行号）。
*   **Query Params**:
    *   `version` (optional): 指定版本，默认最新。
*   **Response (200 OK)**:
    ```json
    {
      "uid": "norm_01...",
      "script_uid": "script_01...",
      "version": "v1",
      "content_json": [
        {"line_id": "S01.L01", "text": "（日，内，警局）", "type": "scene_header"},
        {"line_id": "S01.L02", "text": "老张：这案子不好办。", "type": "dialogue"}
      ]
    }
    ```

---

## 3. 运行控制 (Extraction Run)

### 3.1 启动运行 (Trigger Step 1/2/3)
*   **URL**: `POST /runs/`
*   **Summary**: 触发具体的处理工序。
*   **Request Body**:
    ```json
    {
      "project_uid": "proj_01...",
      "script_uid": "script_01...", // Step 3 可选（如果跨剧本）
      "step": 2, // 1=标准化, 2=候选抽取, 3=归一化
      "model_config": {
        "model": "gpt-4",
        "temperature": 0.0
      }
    }
    ```
*   **Response (200 OK)**:
    ```json
    {
      "uid": "run_01...",
      "status": "running",
      "step": 2,
      "created_at": "..."
    }
    ```

### 3.2 获取运行状态
*   **URL**: `GET /runs/{uid}`
*   **Summary**: 查询任务执行状态。
*   **Response (200 OK)**:
    ```json
    {
      "uid": "run_01...",
      "status": "completed", // running, completed, failed
      "step": 2,
      "error_message": null,
      "finished_at": "..."
    }
    ```

### 3.3 获取剧本的历史运行记录
*   **URL**: `GET /scripts/{script_uid}/runs`
*   **Summary**: 查看某剧本跑过哪些任务。
*   **Response (200 OK)**:
    ```json
    [
      {
        "uid": "run_02...",
        "step": 3,
        "status": "completed",
        "created_at": "..."
      },
      {
        "uid": "run_01...",
        "step": 2,
        "status": "completed",
        "created_at": "..."
      }
    ]
    ```

---

## 4. 候选数据管理 (Candidates & Evidences) - Step 2 产物

### 4.1 获取运行产生的候选实体
*   **URL**: `GET /runs/{run_uid}/candidates`
*   **Summary**: 获取某次 Step 2 运行产生的所有候选实体及证据。
*   **Query Params**:
    *   `entity_type` (optional): 筛选类型 (person/scene/prop)。
*   **Response (200 OK)**:
    ```json
    [
      {
        "uid": "cand_01...",
        "raw_name": "老张",
        "entity_type": "person",
        "confidence": 0.95,
        "canonical_asset_uid": null, // 或者已关联的资产ID
        "evidences": [
          {
            "uid": "evid_01...",
            "line_id": "S01.L02",
            "quote": "老张：这案子不好办。",
            "reason": "名字出现"
          }
        ]
      }
    ]
    ```

### 4.2 修订候选实体 (人工归并)
*   **URL**: `PATCH /candidates/{uid}`
*   **Summary**: 修改候选实体的信息，最常见的是**手动指定归属的规范资产**。
*   **Request Body**:
    ```json
    {
      "canonical_asset_uid": "asset_001", // 将此候选实体归并到 asset_001
      "entity_type": "person" // 也可以修正类型
    }
    ```
*   **Response (200 OK)**:
    ```json
    {
      "uid": "cand_01...",
      "canonical_asset_uid": "asset_001",
      "updated_at": "..."
    }
    ```

### 4.3 删除候选实体
*   **URL**: `DELETE /candidates/{uid}`
*   **Summary**: 软删除完全错误的候选实体。

### 4.4 添加/删除证据
*   **URL**: `POST /candidates/{candidate_uid}/evidences` (添加)
*   **URL**: `DELETE /evidences/{uid}` (删除)
*   **Summary**: 微调某个候选实体的证据列表。

---

## 5. 规范资产管理 (Canonical Assets) - Step 3 产物

### 5.1 获取项目资产列表
*   **URL**: `GET /projects/{project_uid}/assets`
*   **Summary**: 获取项目下的“主数据”资产列表。
*   **Query Params**:
    *   `type`: person/scene/prop
    *   `status`: in_pool/discarded/review_needed
*   **Response (200 OK)**:
    ```json
    [
      {
        "uid": "asset_001",
        "name": "张三",
        "type": "person",
        "aliases": ["老张", "张局长"],
        "status": "in_pool",
        "description": "刑警队长，性格沉稳。",
        "candidate_count": 5 // 关联了多少个候选实体
      }
    ]
    ```

### 5.2 获取资产详情
*   **URL**: `GET /assets/{uid}`
*   **Summary**: 获取资产详情，包括关联的所有候选实体（溯源）。
*   **Response (200 OK)**:
    ```json
    {
      "uid": "asset_001",
      "name": "张三",
      "type": "person",
      "aliases": ["老张", "张局长"],
      "status": "in_pool",
      "description": "...",
      "candidates": [ // 展开关联的候选实体
        {
          "uid": "cand_01...",
          "raw_name": "老张",
          "script_name": "第一集"
        }
      ]
    }
    ```

### 5.3 修订资产信息
*   **URL**: `PATCH /assets/{uid}`
*   **Summary**: 人工修改资产的规范名称、别名、状态等。
*   **Request Body**:
    ```json
    {
      "name": "张三丰",
      "aliases": ["老张", "张局"],
      "status": "in_pool",
      "description": "修改后的描述"
    }
    ```

### 5.4 资产合并 (高级)
*   **URL**: `POST /assets/{target_uid}/merge`
*   **Summary**: 将 `source_uid` 的资产合并到 `target_uid` 中。
*   **Request Body**:
    ```json
    {
      "source_asset_uid": "asset_002" // 这个资产将被标记为废弃或删除，其下的 candidate 会转移到 target_uid
    }
    ```
*   **Response (200 OK)**: 合并后的 `target_uid` 资产详情。
